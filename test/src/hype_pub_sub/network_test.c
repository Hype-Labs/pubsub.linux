#include "network_test.h"

// ID1 KEY:     0000010111101011011000110111110010111101001111110011001101101001000111010111010000111100001010100011100110101111111011101101101001011110110010010100010110101101
byte ID1[] = "\x85\xa9\xd4\xc4\xde\xd2\x87\x75\x0f\xc0\xed\x32";
// ID2 KEY:     1110010010011010101001110111100100101100111101001111110100001001011011000001000000111111010010111010010001100011111000100111101110010001011000001001111001101011
byte ID2[] = "\xe7\x79\x34\x6c\x66\x9c\x17\xf4\x34\xc8\xce\x0e";
// ID3 KEY:     0100010000100000000000011111100101100100110110011111111000110100100110100101111100110000100010101011000101000001000101010000111000000101010110111110010101000110
byte ID3[] = "\x10\x11\x12\x01\x02\x03\x04\x05\x06\x07\x08\x09";
// ID4 KEY:     1111011011001011011011011001110110110000100110001001000110011011001011010011100101010101000100010100000111000101110010111110011101100111101101010000011011010110
byte ID4[] = "\x66\xd8\xf2\x20\x6a\x56\xdb\xe9\x91\x23\x3b\xc2";

// SV1 KEY:     1111111010110101110001101010111010001010101110010111101011011111010100111111100010111100100100101110010101010001011010011000001010110110001000000000111010100100
byte SERVICE_KEY1[] = "\xfe\xb5\xc6\xae\x8a\xb9\x7a\xdf\x53\xf8\xbc\x92\xe5\x51\x69\x82\xb6\x20\x0e\xa4";
// SV2 KEY:     0010010001100010110001000101101001100101110101011001000100110001100001101100100110110011000100001010011010010000100100010110010011110101010111101111011001110111
byte SERVICE_KEY2[] = "\x24\x62\xc4\x5a\x65\xd5\x91\x31\x86\xc9\xb3\x10\xa6\x90\x91\x64\xf5\x5e\xf6\x77";

// XOR SV1/ID1: 1111101101011110101001011101001000110111100001100100100110110110010011101000110010000000101110001101110011111110100001110101100011101000111010010100101100001001
// XOR SV1/ID2: 0001101000101111011000011101011110100110010011011000011111010110001111111110100010000011110110010100000100110010100010111111100100100111010000001001000011001111
// XOR SV1/ID3: 1011101010010101110001110101011111101110011000001000010011101011110010011010011110001100000110000101010000010000011111001000110010110011011110111110101111100010
// XOR SV1/ID4: 0000100001111110101010110011001100111010001000011110101101000100011111101100000111101001100000111010010010010100101000100110010111010001100101010000100001110010 <- LOWER_DISTANCE

// XOR SV2/ID1: 0010000110001001101001110010011011011000111010101010001001011000100110111011110110001111001110101001111100111111011111111011111010101011100101111011001111011010 <- LOWER_DISTANCE
// XOR SV2/ID2: 1100000011111000011000110010001101001001001000010110110000111000111010101101100110001100010110110000001011110011011100110001111101100100001111100110100000011100
// XOR SV2/ID3: 0110000001000010110001011010001100000001000011000110111100000101000111001001011010000011100110100001011111010001100001000110101011110000000001010001001100110001
// XOR SV2/ID4: 1101001010101001101010011100011111010101010011010000000010101010101010111111000011100110000000011110011101010101010110101000001110010010111010111111000010100001

void hpb_network_test()
{
    Network *network = hpb_network_create();
    CU_ASSERT_PTR_NOT_NULL_FATAL(network);

    hpb_network_test_get_service_manager_id(network);
    hpb_network_test_is_client_online(network);

    hpb_network_destroy(&network);
    CU_ASSERT_PTR_NULL(network);
}

void hpb_network_test_get_service_manager_id(Network *network)
{
    hpb_list_clients_add(network->network_clients, ID1);
    hpb_list_clients_add(network->network_clients, ID2);
    hpb_list_clients_add(network->network_clients, ID3);
    hpb_list_clients_add(network->network_clients, ID4);

    // Reset own client id
    memcpy(network->own_client->id, ID1, HPB_ID_BYTE_SIZE);
    sha1_digest(network->own_client->id, HPB_ID_BYTE_SIZE, network->own_client->key);

    CU_ASSERT_NSTRING_EQUAL(hpb_network_get_service_manager_id(network, SERVICE_KEY1), ID4, HPB_ID_BYTE_SIZE);
    CU_ASSERT_NSTRING_EQUAL(hpb_network_get_service_manager_id(network, SERVICE_KEY2), ID1, HPB_ID_BYTE_SIZE);
}

void hpb_network_test_is_client_online(Network *network)
{
    byte TEST_ID1[] = "\x6a\x56\xdb\x66\xd8\xf2\x20\xe9\x91\x23\x3b\xc2";
    byte TEST_ID2[] = "\x20\x6a\x56\xdb\xe9\x91\x23\x66\xd8\xf2\x3b\xc2";

    CU_ASSERT_TRUE(hpb_network_is_client_online(network, ID1));
    CU_ASSERT_TRUE(hpb_network_is_client_online(network, ID2));
    CU_ASSERT_TRUE(hpb_network_is_client_online(network, ID3));
    CU_ASSERT_TRUE(hpb_network_is_client_online(network, ID4));
    CU_ASSERT_FALSE(hpb_network_is_client_online(network, TEST_ID1));
    CU_ASSERT_FALSE(hpb_network_is_client_online(network, TEST_ID2));
}
